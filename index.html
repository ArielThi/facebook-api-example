<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Spotify</title>
    <style>
        :root {
            --spotify-green: #1DB954;
            --spotify-black: #191414;
            --spotify-purple: #5D1DAE;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--spotify-black);
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo img {
            width: 40px;
            height: 40px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 700;
        }
        
        button {
            background-color: var(--spotify-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background-color: #1ed760;
            transform: scale(1.05);
        }
        
        .login-section {
            text-align: center;
            margin: 100px 0;
        }
        
        .login-section h2 {
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        .login-section p {
            margin-bottom: 30px;
            color: #b3b3b3;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .content {
            display: none;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .card {
            background-color: #282828;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            background-color: #3E3E3E;
            transform: translateY(-5px);
        }
        
        .card-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }
        
        .card-content {
            padding: 16px;
        }
        
        .card-title {
            font-weight: 700;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-subtitle {
            color: #b3b3b3;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .loader {
            display: none;
            text-align: center;
            margin: 50px 0;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--spotify-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .profile-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .profile-info h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .profile-info p {
            color: #b3b3b3;
        }
        
        .error-message {
            background-color: #e22134;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .search-container {
            margin-bottom: 30px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 30px;
            border: none;
            background-color: #282828;
            color: white;
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            background-color: #3E3E3E;
        }
        
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 10px 20px;
            background-color: transparent;
            color: #b3b3b3;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 5px;
        }
        
        .tab.active {
            background-color: var(--spotify-green);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            color: #b3b3b3;
            font-size: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" fill="#1DB954"/>
                    <path d="M16.7885 16.7885C16.4325 17.1445 15.8521 17.1445 15.4961 16.7885C13.8793 15.1717 11.5207 15.1717 9.90393 16.7885C9.54789 17.1445 8.96746 17.1445 8.61142 16.7885C8.25538 16.4325 8.25538 15.8521 8.61142 15.4961C10.9281 13.1794 14.4719 13.1794 16.7885 15.4961C17.1445 15.8521 17.1445 16.4325 16.7885 16.7885Z" fill="black"/>
                    <path d="M18.364 13.636C18.0079 13.9921 17.4275 13.9921 17.0715 13.636C14.0572 10.6217 9.94281 10.6217 6.92853 13.636C6.57249 13.9921 5.99206 13.9921 5.63602 13.636C5.27999 13.2799 5.27999 12.6995 5.63602 12.3435C9.36569 8.61379 14.6343 8.61379 18.364 12.3435C18.72 12.6995 18.72 13.2799 18.364 13.636Z" fill="black"/>
                </svg>
                <h1>Explorador de Spotify</h1>
            </div>
            <div id="user-info">
                <button id="login-button">Iniciar sesión con Spotify</button>
                <button id="logout-button" style="display: none; background-color: #282828;">Cerrar sesión</button>
            </div>
        </header>

        <div id="error-message" class="error-message"></div>

        <div id="login-section" class="login-section">
            <h2>Descubre la música que amas</h2>
            <p>Inicia sesión con tu cuenta de Spotify para explorar nuevos artistas, álbumes y listas de reproducción populares.</p>
            <button id="login-button-main">Iniciar sesión con Spotify</button>
        </div>

        <div id="loader" class="loader">
            <div class="loader-spinner"></div>
            <p>Cargando...</p>
        </div>

        <div id="content" class="content">
            <div id="profile-section"></div>

            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Buscar artistas, canciones o álbumes...">
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="new-releases">Nuevos lanzamientos</button>
                <button class="tab" data-tab="featured-playlists">Playlists destacadas</button>
                <button class="tab" data-tab="categories">Categorías</button>
                <button class="tab" data-tab="search-results">Resultados de búsqueda</button>
            </div>

            <div id="new-releases" class="tab-content active">
                <h2 class="section-title">Nuevos lanzamientos</h2>
                <div id="new-releases-grid" class="card-grid"></div>
            </div>

            <div id="featured-playlists" class="tab-content">
                <h2 class="section-title">Playlists destacadas</h2>
                <div id="featured-playlists-grid" class="card-grid"></div>
            </div>

            <div id="categories" class="tab-content">
                <h2 class="section-title">Categorías</h2>
                <div id="categories-grid" class="card-grid"></div>
            </div>

            <div id="search-results" class="tab-content">
                <h2 class="section-title">Resultados de búsqueda</h2>
                <div id="search-results-grid" class="card-grid"></div>
            </div>
        </div>

        <footer>
            <p>Creado con la API de Spotify &copy; 2025</p>
        </footer>
    </div>

    <script>
        // Configuración de la API de Spotify
        const clientId = '043079ac5aad4c6d83513e548b998854';
        const redirectUri = window.location.origin + window.location.pathname;
        const scopes = 'user-read-private user-read-email user-top-read';
        
        // Elementos del DOM
        const loginButton = document.getElementById('login-button');
        const loginButtonMain = document.getElementById('login-button-main');
        const logoutButton = document.getElementById('logout-button');
        const loginSection = document.getElementById('login-section');
        const content = document.getElementById('content');
        const loader = document.getElementById('loader');
        const profileSection = document.getElementById('profile-section');
        const errorMessage = document.getElementById('error-message');
        const searchInput = document.getElementById('search-input');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Grids para los diferentes tipos de contenido
        const newReleasesGrid = document.getElementById('new-releases-grid');
        const featuredPlaylistsGrid = document.getElementById('featured-playlists-grid');
        const categoriesGrid = document.getElementById('categories-grid');
        const searchResultsGrid = document.getElementById('search-results-grid');
        
        // Función para generar el URL de autorización
        function getAuthUrl() {
            const authEndpoint = 'https://accounts.spotify.com/authorize';
            const responseType = 'token';
            
            return `${authEndpoint}?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}&response_type=${responseType}`;
        }
        
        // Función para iniciar sesión
        function login() {
            window.location.href = getAuthUrl();
        }
        
        // Función para cerrar sesión
        function logout() {
            localStorage.removeItem('spotify_token');
            localStorage.removeItem('spotify_token_expiry');
            window.location.href = redirectUri;
        }
        
        // Función para obtener el token de acceso de la URL o del localStorage
        function getAccessToken() {
            // Comprobar si hay un token en localStorage y si sigue siendo válido
            const storedToken = localStorage.getItem('spotify_token');
            const tokenExpiry = localStorage.getItem('spotify_token_expiry');
            
            if (storedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
                return storedToken;
            }
            
            // Si no hay token válido en localStorage, intentar obtenerlo de la URL
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            const expiresIn = params.get('expires_in');
            
            if (accessToken && expiresIn) {
                // Guardar el token y su tiempo de expiración en localStorage
                const expiryTime = Date.now() + parseInt(expiresIn) * 1000;
                localStorage.setItem('spotify_token', accessToken);
                localStorage.setItem('spotify_token_expiry', expiryTime.toString());
                
                // Limpiar la URL para que no muestre el token
                window.history.replaceState({}, document.title, redirectUri);
                
                return accessToken;
            }
            
            return null;
        }
        
        // Función para realizar peticiones a la API de Spotify
        async function fetchFromSpotify(endpoint) {
            const token = getAccessToken();
            
            if (!token) {
                throw new Error('No hay token de acceso disponible');
            }
            
            try {
                const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expirado o inválido
                        localStorage.removeItem('spotify_token');
                        localStorage.removeItem('spotify_token_expiry');
                        throw new Error('Sesión expirada. Por favor, inicia sesión de nuevo.');
                    }
                    throw new Error(`Error en la petición: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error al realizar la petición:', error);
                throw error;
            }
        }
        
        // Función para mostrar el perfil del usuario
        async function showUserProfile() {
            try {
                const userData = await fetchFromSpotify('/me');
                
                const profileImage = userData.images && userData.images.length > 0 
                    ? userData.images[0].url 
                    : 'https://via.placeholder.com/150';
                
                const profileHTML = `
                    <div class="profile">
                        <img src="${profileImage}" alt="Foto de perfil" class="profile-img">
                        <div class="profile-info">
                            <h2>${userData.display_name || 'Usuario de Spotify'}</h2>
                            <p>${userData.followers.total} seguidores</p>
                        </div>
                    </div>
                `;
                
                profileSection.innerHTML = profileHTML;
            } catch (error) {
                showError(`Error al cargar el perfil: ${error.message}`);
            }
        }
        
        // Función para mostrar nuevos lanzamientos
        async function showNewReleases() {
            try {
                const data = await fetchFromSpotify('/browse/new-releases?limit=20&country=ES');
                
                const albums = data.albums.items;
                let html = '';
                
                albums.forEach(album => {
                    const albumImage = album.images && album.images.length > 0 
                        ? album.images[0].url 
                        : 'https://via.placeholder.com/200';
                    
                    const artistNames = album.artists.map(artist => artist.name).join(', ');
                    
                    html += `
                        <div class="card" data-id="${album.id}" data-type="album">
                            <img src="${albumImage}" alt="${album.name}" class="card-img">
                            <div class="card-content">
                                <h3 class="card-title">${album.name}</h3>
                                <p class="card-subtitle">${artistNames}</p>
                            </div>
                        </div>
                    `;
                });
                
                newReleasesGrid.innerHTML = html;
                
                // Añadir event listeners a las tarjetas
                document.querySelectorAll('#new-releases-grid .card').forEach(card => {
                    card.addEventListener('click', () => {
                        const albumId = card.getAttribute('data-id');
                        window.open(`https://open.spotify.com/album/${albumId}`, '_blank');
                    });
                });
            } catch (error) {
                showError(`Error al cargar nuevos lanzamientos: ${error.message}`);
            }
        }
        
        // Función para mostrar playlists destacadas
        async function showFeaturedPlaylists() {
            try {
                const data = await fetchFromSpotify('/browse/featured-playlists?limit=20&country=ES');
                
                const playlists = data.playlists.items;
                let html = '';
                
                playlists.forEach(playlist => {
                    const playlistImage = playlist.images && playlist.images.length > 0 
                        ? playlist.images[0].url 
                        : 'https://via.placeholder.com/200';
                    
                    html += `
                        <div class="card" data-id="${playlist.id}" data-type="playlist">
                            <img src="${playlistImage}" alt="${playlist.name}" class="card-img">
                            <div class="card-content">
                                <h3 class="card-title">${playlist.name}</h3>
                                <p class="card-subtitle">${playlist.tracks.total} canciones</p>
                            </div>
                        </div>
                    `;
                });
                
                featuredPlaylistsGrid.innerHTML = html;
                
                // Añadir event listeners a las tarjetas
                document.querySelectorAll('#featured-playlists-grid .card').forEach(card => {
                    card.addEventListener('click', () => {
                        const playlistId = card.getAttribute('data-id');
                        window.open(`https://open.spotify.com/playlist/${playlistId}`, '_blank');
                    });
                });
            } catch (error) {
                showError(`Error al cargar playlists destacadas: ${error.message}`);
            }
        }
        
        // Función para mostrar categorías
        async function showCategories() {
            try {
                const data = await fetchFromSpotify('/browse/categories?limit=20&country=ES');
                
                const categories = data.categories.items;
                let html = '';
                
                categories.forEach(category => {
                    const categoryImage = category.icons && category.icons.length > 0 
                        ? category.icons[0].url 
                        : 'https://via.placeholder.com/200';
                    
                    html += `
                        <div class="card" data-id="${category.id}" data-type="category">
                            <img src="${categoryImage}" alt="${category.name}" class="card-img">
                            <div class="card-content">
                                <h3 class="card-title">${category.name}</h3>
                            </div>
                        </div>
                    `;
                });
                
                categoriesGrid.innerHTML = html;
                
                // Añadir event listeners a las tarjetas
                document.querySelectorAll('#categories-grid .card').forEach(card => {
                    card.addEventListener('click', () => {
                        const categoryId = card.getAttribute('data-id');
                        showCategoryPlaylists(categoryId);
                    });
                });
            } catch (error) {
                showError(`Error al cargar categorías: ${error.message}`);
            }
        }
        
        // Función para buscar en Spotify
        async function search(query) {
            if (!query.trim()) {
                searchResultsGrid.innerHTML = '<p>Introduce un término de búsqueda</p>';
                return;
            }
            
            try {
                showLoader();
                const data = await fetchFromSpotify(`/search?q=${encodeURIComponent(query)}&type=track,artist,album&limit=20`);
                hideLoader();
                
                let html = '';
                
                // Artistas
                if (data.artists && data.artists.items.length > 0) {
                    html += '<h3 class="section-title">Artistas</h3><div class="card-grid">';
                    
                    data.artists.items.forEach(artist => {
                        const artistImage = artist.images && artist.images.length > 0 
                            ? artist.images[0].url 
                            : 'https://via.placeholder.com/200';
                        
                        html += `
                            <div class="card" data-id="${artist.id}" data-type="artist">
                                <img src="${artistImage}" alt="${artist.name}" class="card-img">
                                <div class="card-content">
                                    <h3 class="card-title">${artist.name}</h3>
                                    <p class="card-subtitle">Artista</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // Álbumes
                if (data.albums && data.albums.items.length > 0) {
                    html += '<h3 class="section-title">Álbumes</h3><div class="card-grid">';
                    
                    data.albums.items.forEach(album => {
                        const albumImage = album.images && album.images.length > 0 
                            ? album.images[0].url 
                            : 'https://via.placeholder.com/200';
                        
                        const artistNames = album.artists.map(artist => artist.name).join(', ');
                        
                        html += `
                            <div class="card" data-id="${album.id}" data-type="album">
                                <img src="${albumImage}" alt="${album.name}" class="card-img">
                                <div class="card-content">
                                    <h3 class="card-title">${album.name}</h3>
                                    <p class="card-subtitle">${artistNames}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // Canciones
                if (data.tracks && data.tracks.items.length > 0) {
                    html += '<h3 class="section-title">Canciones</h3><div class="card-grid">';
                    
                    data.tracks.items.forEach(track => {
                        const trackImage = track.album.images && track.album.images.length > 0 
                            ? track.album.images[0].url 
                            : 'https://via.placeholder.com/200';
                        
                        const artistNames = track.artists.map(artist => artist.name).join(', ');
                        
                        html += `
                            <div class="card" data-id="${track.id}" data-type="track">
                                <img src="${trackImage}" alt="${track.name}" class="card-img">
                                <div class="card-content">
                                    <h3 class="card-title">${track.name}</h3>
                                    <p class="card-subtitle">${artistNames}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                if (html === '') {
                    html = '<p>No se encontraron resultados para tu búsqueda</p>';
                }
                
                searchResultsGrid.innerHTML = html;
                
                // Cambiar a la pestaña de resultados de búsqueda
                setActiveTab('search-results');
                
                // Añadir event listeners a las tarjetas
                document.querySelectorAll('#search-results-grid .card').forEach(card => {
                    card.addEventListener('click', () => {
                        const id = card.getAttribute('data-id');
                        const type = card.getAttribute('data-type');
                        window.open(`https://open.spotify.com/${type}/${id}`, '_blank');
                    });
                });
            } catch (error) {
                hideLoader();
                showError(`Error al realizar la búsqueda: ${error.message}`);
            }
        }
        
        // Función para mostrar un mensaje de error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            
            // Ocultar el mensaje después de 5 segundos
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // Función para mostrar el loader
        function showLoader() {
            loader.style.display = 'block';
        }
        
        // Función para ocultar el loader
        function hideLoader() {
            loader.style.display = 'none';
        }
        
        // Función para cambiar entre pestañas
        function setActiveTab(tabId) {
            // Desactivar todas las pestañas
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ocultar todos los contenidos de pestañas
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Activar la pestaña seleccionada
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // Event listeners
        loginButton.addEventListener('click', login);
        loginButtonMain.addEventListener('click', login);
        logoutButton.addEventListener('click', logout);
        
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                search(searchInput.value);
            }
        });
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                setActiveTab(tabId);
            });
        });
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', async () => {
            const token = getAccessToken();
            
            if (token) {
                // Usuario autenticado
                loginSection.style.display = 'none';
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                
                try {
                    showLoader();
                    
                    // Cargar datos del usuario y contenido
                    await showUserProfile();
                    await showNewReleases();
                    await showFeaturedPlaylists();
                    await showCategories();
                    
                    // Mostrar el contenido
                    content.style.display = 'block';
                    hideLoader();
                } catch (error) {
                    hideLoader();
                    showError(`Error al cargar los datos: ${error.message}`);
                    
                    // Si hay un error de autenticación, volver a mostrar la pantalla de login
                    if (error.message.includes('Sesión expirada')) {
                        loginSection.style.display = 'block';
                        loginButton.style.display = 'block';
                        logoutButton.style.display = 'none';
                        content.style.display = 'none';
                    }
                }
            } else {
                // Usuario no autenticado
                loginSection.style.display = 'block';
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                content.style.display = 'none';
            }
        });
    </script>
</body>
</html>
